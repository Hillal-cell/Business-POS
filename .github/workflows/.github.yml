name: CI/CD Pipeline

on:
  pull_request:
    branches:
      - develop
  push:
    branches:
      - develop
      - main

env:
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/results-management
  VERSION_TAG: v1.${{ github.run_number }}
  POSTGRES_DB: testing
  POSTGRES_USER: laravel
  POSTGRES_PASSWORD: laravel

jobs:
  build:
    name: Build Docker image
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'pull_request' &&
      (github.event.pull_request.base.ref == 'develop')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push image
        run: |
          echo "Building Docker image with version ${VERSION_TAG}..."
          docker build -t ${IMAGE_NAME}:${VERSION_TAG} .
          docker tag ${IMAGE_NAME}:${VERSION_TAG} ${IMAGE_NAME}:latest
          docker push ${IMAGE_NAME}:${VERSION_TAG}
          docker push ${IMAGE_NAME}:latest

  test:
    name: Run integration tests
    runs-on: ubuntu-latest
    needs: build
    if: >-
      github.event_name == 'pull_request' &&
      (github.event.pull_request.base.ref == 'develop')
    services: {}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Docker is available
        run: docker info

      - name: Clean existing test containers
        run: |
          docker rm -f test-db test-app 2>/dev/null || true

      - name: Start Postgres test DB
        run: |
          docker run -d --name test-db \
            -e POSTGRES_USER=${POSTGRES_USER} \
            -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD} \
            -e POSTGRES_DB=${POSTGRES_DB} \
            postgres:14

      - name: Wait for DB
        run: sleep 15

      - name: Login and pull image
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker pull ${IMAGE_NAME}:latest

      - name: Run app container
        run: |
          docker run -d --name test-app --link test-db:db \
            -e DB_CONNECTION=pgsql \
            -e DB_HOST=db \
            -e DB_PORT=5432 \
            -e DB_DATABASE=${POSTGRES_DB} \
            -e DB_USERNAME=${POSTGRES_USER} \
            -e DB_PASSWORD=${POSTGRES_PASSWORD} \
            ${IMAGE_NAME}:latest

      - name: Run Laravel tests
        run: |
          docker exec test-app php artisan key:generate --force
          docker exec test-app php artisan migrate --force
          docker exec test-app vendor/bin/phpunit

      - name: Cleanup
        if: always()
        run: |
          docker stop test-app test-db 2>/dev/null || true
          docker rm -f test-app test-db 2>/dev/null || true

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: test
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openssh-client
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SERVER_IP }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy via SSH to staging
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          STAGING_APP_PORT: ${{ secrets.STAGING_APP_PORT }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          ssh -o StrictHostKeyChecking=yes "${{ secrets.USERNAME }}@${{ secrets.SERVER_IP }}" /bin/bash <<'ENDSSH'
            set -e
            cd "$DEPLOY_PATH"

            git fetch https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.cranecloud.io/${CI_PROJECT_PATH}.git develop:remotes/origin/develop || true
            git checkout develop || true
            git reset --hard origin/develop || true

            export DOCKER_USERNAME=${DOCKER_USERNAME}
            export SERVER_IP=${SERVER_IP}
            export ENVIRONMENT=staging
            export APP_PORT=${STAGING_APP_PORT}
            export DB_PORT=5445
            export POSTGRES_USER=laravel_staging
            export POSTGRES_PASSWORD=laravel_staging
            export POSTGRES_DB=results_staging

            echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
            docker pull ${DOCKER_USERNAME}/results-management:latest || true

            docker stop results-app-staging results-db-staging results-staging_app_1 results-staging_db_1 results-management-app results-management-db 2>/dev/null || true
            docker rm results-app-staging results-db-staging results-staging_app_1 results-staging_db_1 results-management-app results-management-db 2>/dev/null || true

            docker-compose -p results-staging up -d

            sleep 20

            docker-compose -p results-staging exec -T app php artisan key:generate --force || true
            docker-compose -p results-staging exec -T app php artisan storage:link || true
            docker-compose -p results-staging exec -T app php artisan migrate --force || true
            docker-compose -p results-staging exec -T app php artisan config:clear || true
            docker-compose -p results-staging exec -T app php artisan cache:clear || true
            docker-compose -p results-staging exec -T app php artisan view:clear || true
          ENDSSH

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: test
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openssh-client
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SERVER_IP }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy via SSH to production
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          PRODUCTION_APP_PORT: ${{ secrets.PRODUCTION_APP_PORT }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          ssh -o StrictHostKeyChecking=yes "${{ secrets.USERNAME }}@${{ secrets.SERVER_IP }}" /bin/bash <<'ENDSSH'
            set -e
            cd "$DEPLOY_PATH"

            git fetch https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.cranecloud.io/${CI_PROJECT_PATH}.git main:remotes/origin/main || true
            git checkout main || true
            git reset --hard origin/main || true

            export DOCKER_USERNAME=${DOCKER_USERNAME}
            export SERVER_IP=${SERVER_IP}
            export ENVIRONMENT=production
            export APP_PORT=${PRODUCTION_APP_PORT}
            export DB_PORT=5447
            export POSTGRES_USER=laravel_production
            export POSTGRES_PASSWORD=laravel_production
            export POSTGRES_DB=results_production

            echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
            docker pull ${DOCKER_USERNAME}/results-management:latest || true

            docker stop results-app-production results-db-production results-production_app_1 results-production_db_1 results-management-app results-management-db 2>/dev/null || true
            docker rm results-app-production results-db-production results-production_app_1 results-production_db_1 results-management-app results-management-db 2>/dev/null || true

            docker-compose -p results-production up -d

            sleep 20

            docker-compose -p results-production exec -T app php artisan key:generate --force || true
            docker-compose -p results-production exec -T app php artisan storage:link || true
            docker-compose -p results-production exec -T app php artisan migrate --force || true
            docker-compose -p results-production exec -T app php artisan config:clear || true
            docker-compose -p results-production exec -T app php artisan cache:clear || true
            docker-compose -p results-production exec -T app php artisan view:clear || true
          ENDSSH
